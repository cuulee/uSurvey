version: '2'

services:

  usurvey_app:
    environment:
      # pick db details from environment variables
      - DATABASE_URL=postgres://${USURVEY_DB_USER}:${USURVEY_DB_PASS}@db/${USURVEY_DB}
      - REDIS_HOST=redis_server
      - USURVEY_DB_HOST=db
      - USURVEY_DB
      - USURVEY_DB_USER
      - USURVEY_DB_PASS
    image: antsmc2/usurvey
    command: gunicorn -b 0.0.0.0:3691 --workers=$USURVEY_APP_WORKERS  --max-requests $USURVEY_APP_MAX_REQUESTS --timeout $USURVEY_APP_TIMEOUT mics.wsgi
    depends_on:
      - redis_server
      - db
    ports:
      - "$USURVEY_APP_PORT:3691"

  db:
    environment:
      # pls replace with your own values
      POSTGRES_DB: ${USURVEY_DB}
      POSTGRES_USER: ${USURVEY_DB_USER}
      POSTGRES_PASSWORD: ${USURVEY_DB_PASS}
    restart: always
    image: postgres:alpine
    ports:
      - "5430:5432"
    volumes:
      - ${POSTGRES_DATA_PATH}:/var/lib/postgresql/data

  redis_server:
    restart: always
    image: redis:alpine
    ports:
      - "6378:6379"

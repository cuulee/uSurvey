version: '2'

services:

  usurvey_app:
    environment:
      # pick db details from environment variables
      - DATABASE_URL=postgres://${USURVEY_DB_USER}:${USURVEY_DB_PASS}@db/${USURVEY_DB}
      - REDIS_HOST=redis_server
      - USURVEY_DB_HOST=db
      - USURVEY_DB
      - USURVEY_DB_USER
      - USURVEY_DB_PASS
      - EMAIL_HOST
      - EMAIL_PORT
      - EMAIL_HOST_USER
      - EMAIL_HOST_PASSWORD
      - DEFAULT_EMAIL_SENDER
      - SHAPE_FILE_URI
      - SHAPE_FILE_LOC_FIELD
      - SHAPE_FILE_LOC_ALT_FIELD
      - MAP_CENTER
      - MAP_ADMIN_LEVEL
      - MAP_ZOOM_LEVEL
      - COUNTRY
      - TIME_ZONE
      - USURVEY_SECRET_KEY

    image: antsmc2/usurvey
    command: gunicorn -b 0.0.0.0:3691 --workers=$USURVEY_APP_WORKERS  --max-requests $USURVEY_APP_MAX_REQUESTS --timeout $USURVEY_APP_TIMEOUT mics.wsgi
    depends_on:
      - redis_server
      - db
    ports:
      - "$USURVEY_APP_PORT:3691"
    volumes:
      - ._docker_mapf:/src/survey/static/map_resources


  db:
    environment:
      # pls replace with your own values
      POSTGRES_DB: ${USURVEY_DB}
      POSTGRES_USER: ${USURVEY_DB_USER}
      POSTGRES_PASSWORD: ${USURVEY_DB_PASS}
    restart: always
    image: postgres:alpine
    ports:
      - "$USURVEY_DB_PORT:5432"
    volumes:
      - ${POSTGRES_DATA_PATH}:/var/lib/postgresql/data

  redis_server:
    restart: always
    image: redis:alpine
    ports:
      - "$USURVEY_REDIS_PORT:6379"

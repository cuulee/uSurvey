<h:html xmlns="http://www.w3.org/2002/xforms"
xmlns:h="http://www.w3.org/1999/xhtml"
xmlns:ev="http://www.w3.org/2001/xml-events"
xmlns:xsd="http://www.w3.org/2001/XMLSchema"
xmlns:jr="http://openrosa.org/javarosa">
{% load template_tags %}
<h:head>
<h:title>
	{% if title %}
		{{ title }}
	{% else %}
	  {{qset.name}}
	{% endif %}

</h:title>
  <model>
  <instance>
   <qset id="{{ qset.pk }}" >
     <meta>
       <instanceID />
       <instanceName />
     </meta>
	   <type>{{ stage }}</type> {% comment %} basically tells if it's listing or survey data. status may change {% endcomment %}
	   <surveyAllocation />
	   <qset{{ qset.pk }}>
	   {% if ea_samples %}
	     <sampleData>
			 <selectedSample />
		   {% for ea_id, samples in ea_samples.items %}
				<iq{{ ea_id }} />
			{% endfor %}
		</sampleData>
	   {% endif %}
			<questions>
			   {% comment %} Would come back to this
			   <groupQuestion>
				   {% for question in group_questions %}
						<p{{question.pk}} />
				   {% endfor %}
			   </groupQuestion>
			   {% endcomment %}
				{% for question in qset.questions_inline %}
				   {% if question.loop_started %}
					   <q{{question.pk}}q{{question.loop_started.loop_ender.pk}}>
						<id />
				   {% endif %}
							<q{{question.pk}} />
							{% for sub_question in question.direct_sub_questions %}
							<q{{sub_question.pk}} />
							{% endfor %}
				   {% if question.loop_ended %}
					   </q{{question.loop_ended.loop_starter.pk}}q{{question.pk}}>
				   {% endif %}
				{% endfor %}
			</questions>
	   </qset{{ qset.pk }}>
   </qset>
  </instance>

  <!-- bindings -->
  <bind nodeset="/qset/meta/instanceID" type="string" 
           readonly="true()" calculate="concat('uuid:',uuid())" />
  <bind nodeset="/qset/meta/instanceName" type="string" 
           readonly="true()" calculate="concat('{{ qset.name}}', /qset/surveyAllocation)" />
  <bind nodeset="/qset/surveyAllocation" type="select1" required="true()" />
	<bind nodeset="/qset/qset{{qset.pk}}/sampleData/selectedSample" type="string" readonly="true()"
			calculate="concat({% for ea_id in ea_samples %}/qset/qset{{qset.pk}}/sampleData/iq{{ ea_id }},'-',{% endfor %}'')"/>
	{% for ea_id, samples in ea_samples.items %}
		{% is_relevant_sample ea_id assignments as  relevant_sample_context %}
		<bind nodeset="/qset/qset{{qset.pk}}/sampleData/iq{{ ea_id }}" type="select1" required="true()"  relevant="{{ relevant_sample_context }}"/>
	{% endfor %}

	{% for question in qset.flow_questions  %}
		{% is_relevant_odk question interviewer as relevance_context %}
	    {% get_loop_aware_path question  as path %}
	       {% if question.loop_started %}
	           <bind nodeset="/qset/qset{{qset.pk}}/questions{{ path }}"
				required="true()"
				relevant="true() and {{ relevance_context }}"/>
				<bind nodeset="/qset/qset{{qset.pk}}/questions{{ path }}/id"
				required="true()"
				relevant="true() and {{ relevance_context }}" readonly="true()" calculate="position(..)"/>
	       {% endif %}

			<bind nodeset="/qset/qset{{qset.pk}}/questions{{ path }}/q{{question.pk}}"
				type="{% if question.answer_type == answer_types.numericalanswer %}int{% elif question.answer_type == answer_types.multichoiceanswer %}select1{% elif question.answer_type == answer_types.multiselectanswer %}select{% elif question.answer_type == answer_types.dateanswer %}date{% elif question.answer_type == answer_types.audioanswer or answer_type == answer_types.imageanswer or answer_type == answer_types.videoanswer %}binary{% elif question.answer_type == answer_types.geopointanswer %}geopoint{% else %}string{% endif %}"
				required="{% if question.mandatory %}true(){% else %}false(){% endif %}"
				relevant="true() and {{ relevance_context }}"/>
			{% comment %}{% if question.loop_ended %}
				<bind nodeset="/qset/qset{{qset.pk}}/questions{{ path }}/loop_id" type="string" 
           readonly="true()" calculate="count(/qset/qset{{qset.pk}}/questions{{ path }}/q{{question.pk}})" />
	       {% endif %}{% endcomment %}
	{% endfor %}

  </model>
</h:head>
<h:body>
    <select ref="/qset/surveyAllocation">
		<label>Select EnumerationArea</label>
		{% for assignment in assignments %}
		<item>
			<label>{{assignment.allocation_ea.name}}</label>
			<value>{{ assignment.pk }}</value>
		</item>
		{% endfor %}
	</select>
	{% if ea_samples %}
		<group>
			{% for ea_id, samples in ea_samples.items %}
			   {% if samples %}
					<select ref="/qset/qset{{qset.pk}}/sampleData/iq{{ ea_id }}">
						<label>Select Sample</label>
						{% for sample in samples %}
						{% get_sample_data_display sample as  sample_label %}
						<item>
							<label>{{ sample_label }}</label>
							<value>{{ sample.interview.pk }}</value>
						</item>
						{% endfor %}
					</select>
				{% endif %}
			{% endfor %}
		</group>
	{% endif %}
	<group>
		<label>{{ qset.name }}</label>
		<hint>{{ qset.description }}</hint>
		{% for question in qset.questions_inline %}
		   {% get_loop_aware_path question  as path %}
		   {% if question.loop_started %}
		       <group {% if question.loop_started.loop_prompt %}prompt="{{question.loop_started.loop_prompt}}"{% endif %}>
					<label>{{question.loop_started.loop_label}}</label>
	           		<repeat nodeset="/qset/qset{{qset.pk}}/questions{{ path }}" {% if question.loop_started.repeat_logic == question.loop_started.PREVIOUS_QUESTION %}
													{% get_loop_aware_path question.loop_started.previousanswercount.value  as counter_path %}
													jr:count="/qset/qset{{qset.pk}}/questions{{counter_path}}/q{{question.loop_started.previousanswercount.value.pk}}"
												{% elif question.loop_started.repeat_logic == question.loop_started.FIXED_REPEATS %}
													jr:count="{{question.loop_started.fixedloopcount.value}}"
												{% endif %}>

	       {% endif %}
					{% include "odk/_question_body.xml" with question=question answer_types=answer_types %}
					 {% for sub_question in question.direct_sub_questions %}
	                	{% include "odk/_question_body.xml" with question=sub_question answer_types=answer_types %}
	   				{% endfor %}
				{% if question.loop_ended %}
		      		</repeat>
			 </group>
	       {% endif %}
		{% endfor %}
	</group>

</h:body>
</h:html>

{% extends "layout.html" %}
{% block extra_head %}
    <!-- link rel="stylesheet" href="{{ STATIC_URL }}leaflet/leaflet.css" / -->
    <style>
        #container {
            height: 500px;
            min-width: 310px;
            max-width: 800px;
            margin: 0 auto;
        }

        .loading {
            margin-top: 10em;
            text-align: center;
            color: gray;
        }
/*
		body {
			font-family:"Trebuchet MS", Arial, Helvetica, sans-serif;
			font-size:12px;

		}*/

        body {
            font-family:"Trebuchet MS", Arial, Helvetica, sans-serif;            
        }

		select, textarea, input[type="text"], input[type="password"], input[type="datetime"], input[type="datetime-local"], input[type="date"], input[type="month"], input[type="time"], input[type="week"], input[type="number"], input[type="email"], input[type="url"], input[type="search"], input[type="tel"], input[type="color"], .uneditable-input {
    border-radius: 4px;
    color: #555555;
    display: inline-block;
    font-size: 14px;
    height: 20px;
    line-height: 20px;
    margin-bottom: 10px;
    padding: 4px 6px;
    vertical-align: middle;
}
input, textarea, .uneditable-input {
    width: 206px;
}
textarea {
    height: auto;
}
.leaflet-left .leaflet-control {
    margin-left: 10px;
}
.leaflet-top .leaflet-control {
    margin-top: 10px;
}
select, input[type="file"] {
    height: 30px;
    line-height: 30px;
}
.leaflet-popup-pane, .leaflet-control {
    cursor: auto;
}
.leaflet-control {
    clear: both;
    float: left;
}
select {
    background-color: #ffffff;
    border: 1px solid #0099ff;
    width: 220px;
}
select, input[type="file"] {
    height: 30px;
    line-height: 30px;
}
   /*
   .leaflet-bottom .leaflet-control {
    margin-bottom: 276px;
    margin-right: 191px;
}*/
   .leaflet-bottom {
    bottom: 0;
}
.leaflet-right {
    right: 0;
}
.leaflet-top, .leaflet-bottom {
    pointer-events: none;
    position: absolute;
    z-index: 1000;
}
.leaflet-container {
    font: 12px/1.5 "Helvetica Neue",Arial,Helvetica,sans-serif;
}
.leaflet-container {
    cursor: grab;
}


.leaflet-right .leaflet-control {
    margin-right: 10px;
}
.leaflet-bottom .leaflet-control {
background: #e3e3e3 none repeat scroll 0 0;
    border: 1px solid #0099ff;
    color: #000;
    font-family: trebuchet ms;
    font-size: 12px;
    margin-bottom: 105px;
    margin-right: 125px;
}

}
.leaflet-right .leaflet-control {
    float: right;
}
.leaflet-control2 {
    float: right;
}
.info {
    background: rgba(255, 255, 255, 0.8) none repeat scroll 0 0;
    border-radius: 5px;
    box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
    font: 16px Arial,Helvetica,sans-serif;
    height: 150px;
    padding: 10px;
    width:138px;
}
.legend {
    color: #555;
    line-height: 18px;
}
.leaflet-popup-pane, .leaflet-control {
    cursor: auto;
}
.leaflet-control {
   /* clear: both;
    float: left;*/
	margin-left:256px;
	margin-top:50px;
}
.leaflet-control {
    pointer-events: auto;
    position: relative;
    z-index: 7;
}

.info h1 {
    color: #777;
    font: 20px Arial,Helvetica,sans-serif !important;
    margin: 0 0 5px;
}
h1 {
    font-size: 38.5px;
}
h1, h2, h3 {
    line-height: 40px;
}
h1, h2, h3, h4, h5, h6 {
    color: inherit;
    font-family: inherit;
    font-weight: bold;
    line-height: 20px;
    margin: 10px 0;
    text-rendering: optimizelegibility;
}
.legend i {
    float: left;
    height: 18px;
    line-height: 1.5em;
    margin-right: 8px;
    opacity: 0.7;
    width: 15px;
}
    </style>
{% endblock %}
{% block title %}
  Survey Map
{% endblock %}
{% block content %}
<div id="completion_map" >
</div>
<form id="completion_form" class="hide">
<select id="surveys" >
    <option value="">Choose a survey</option>
    {% for survey in surveys %}
        <option value="{{ survey.id }}">{{ survey.name }}</option>
    {%  endfor %}
</select>
</form>
{% endblock%}

{% block javascripts %}
    <script src="{{ STATIC_URL }}leaflet/leaflet.js"></script>
    <script type="text/javascript">
        var map = L.map('completion_map').setView([1.34,32.683525], 7, {zoomControl: true, doubleClickZoom: false, scrollWheelZoom:false}),
    osmUrl='https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
    info = L.control(),
    legend = L.control({position: 'bottomright'}),
    geojson;
  osmAttrib='Mics survey  Â© Mics';
  layer = new L.TileLayer(osmUrl, {minZoom: 6, maxZoom: 12, attribution: osmAttrib});

map.addLayer(layer);

$(function(){
    $("#surveys").on('change', function(){
        getCompletionFor($(this).val())

    })
});

function getCompletionFor(survey_id){
    $.getJSON("/survey/"+ survey_id +"/completion/json/", function (rate_data) {
        $.getJSON("{{shape_file_uri}}", function (data) {
          $.each(data, function(element){
             data.features.map(function(feature){
              var property = feature.properties['{{loc_field}}'];
              if(property === undefined)
                property = feature.properties['{{alt_loc_field}}'];
              if(property)
                property = property.toUpperCase();
              feature.properties.rate = rate_data[property]
            })
          });
       geojson = L.geoJson(data, {style: style, onEachFeature: onEachFeature}).addTo(map);
      });
    });
}

function getColorFor(rate) {
    return rate > 80 && rate <= 100 ? '#800026' :
           rate > 60 && rate <= 80  ? '#BD0026' :
           rate > 40 && rate <= 60  ? '#E31A1C' :
           rate > 20 && rate <= 40  ? '#FC4E2A' :
           rate > 0  && rate <= 20  ? '#FD8D3C' :
           rate == 0 ? '#FFFFFF':
           '#D1D0CE';
    }

function style(feature) {
    return {
        fillColor: getColorFor(feature.properties.rate),
        weight: 2,
        opacity: 0.55,
        color: '#FD8D3C',
        dashArray: '3',
        fillOpacity: 1
    };
}

function onEachFeature(feature, layer) {
    layer.on({
      mouseover: highlightDistrict,
      click: zoomDistrict,
      mouseout: resetDistrictHighlight
  });
}

info.onAdd = function (map) {
  this._div = L.DomUtil.create('div', 'info');
  this.update();
  return this._div;
};
info.update = function (props) {
  this._div.innerHTML = '<h1>Completion rates:</h1>';
  if(typeof props != 'undefined'){
    var property = props['{{loc_field}}'];
    if(property === undefined)
        property = props['{{alt_loc_field}}'];
    if(property)
       property = property.toUpperCase();
    rate = props.rate >-1 ? props.rate + '%' : 'Survey not opened.';
    this._div.innerHTML += property +': '+ rate;
  }
};

var legend = L.control({position: 'bottomright'});

legend.onAdd = function (map) {
    var div = L.DomUtil.create('div', 'info legend'),
        grades = [0,20, 40, 60, 80, 100];
    div.innerHTML += "<h1>Key</h1>"
        + '<i style="background:' + getColorFor(-1) + '"></i>'+ " Survey not opened<br/>";
    for (var i = 0; i < grades.length; i++) {
        div.innerHTML +=
            '<i style="background:' + getColorFor(grades[i] + 1) + '"></i> ';
        if(typeof  grades[i] != 'undefined' && typeof  grades[i +1] != 'undefined'){
            div.innerHTML += grades[i] +" &mdash; "+ (grades[i + 1]) + "% <br/>"
        }
    }
    return div;
};

var survey_selector = L.control({position: 'topleft'});

    survey_selector.onAdd = function(map){
        var selector_div = L.DomUtil.create('div', 'survey');
        var surveysHtml = $('#completion_form');
        $(selector_div).html(surveysHtml.html());
        $(surveysHtml).removeAttr('class', 'hide')
        $(surveysHtml).remove()
        return selector_div;
    }

legend.addTo(map);
info.addTo(map);
survey_selector.addTo(map)

function highlightDistrict(event){
    var layer = event.target
    layer.setStyle({
        weight: 3,
        color:'#666',
        dashArray: '',
        fillOpacity: 0.3
    })
   if (!L.Browser.ie && !L.Browser.opera) {
        layer.bringToFront();
    }

    info.update(layer.feature.properties)
}

function zoomDistrict(event){
    map.fitBounds(event.target.getBounds())
}

function resetDistrictHighlight(event){
    geojson.resetStyle(event.target)
}

    </script>
{% endblock %}

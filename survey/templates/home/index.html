{% extends "layout.html" %}
{% block extra_head %}
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>


    <style>
        .map-show {
            width: 80%
            display: inline-block;
        }

        #indicators {
            
            
        }

        .map-legend {
            width: 16px;
            height: 16px;
            display: inline-block;
        }

        .leaflet-container {
            margin-bottom: 10px;
            margin-left: 384px;
            background-color:rgba(255,0,0,0.0);
        }

        .dataTables_wrapper .row:first-child {
            display: none;
          }

        .dataTables_wrapper label {
            display: inline-block !important;
            font-size: 13px !important;
            margin-top: 20px !important;
            margin-left: -25px !important;
        }
        .rop {
         text-align:center;
         }
         .leaflet-container {
            margin-left: 384px;
            /*margin-top: 77px;*/
            overflow: hidden;

        }
        .leaflet-container {
            margin-bottom: 10px;
            margin-left: 384px;
             overflow: hidden;
        }

        /*
        1px solid #c5c5c6;
        5px 5px 5px #dbddde;
        */
        #survey_map {
            border: None;
            box-shadow: None;
            height: 500px;
            margin-left: auto;
            margin-right: auto;
            width: 500px;
            margin-top: 40px;
            z-index: 2;    
        }
@media only screen and (max-width:767px) {
    #survey_map {
       width: 100%
    }
  </style>
  <style>
/*.info { padding: 6px 8px; font: 12px "Trebuchet MS",Open Sans, Helvetica, sans-serif; background: white; background: rgba(255,255,255,0.8); box-shadow: 0 0 15px rgba(0,0,0,0.2); border-radius: 5px; } */
.info {
    background: rgba(255, 255, 255, 0.8) none repeat scroll 0 0;
    border: 1px solid #4695fb;
    border-radius: 5px;
    box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
    font-family: Trebuchet MS;
    font-size: 14px;
    color: #307ecc;
    padding: 6px 8px;
}
.info h4 { margin: 0 0 5px; color: #777; }
.legend { text-align: left; line-height: 18px; color: #555; } .legend i { width: 18px; height: 18px; float: left; margin-right: 8px; opacity: 0.7;}
.ptop{padding-top: 10px;}
#map-legend{line-height: 20px;font-size: 13px;font-weight: bold;}
#map-legend strong{line-height: 3em;

font-family: MontserratBold, Arial, Helvetica, sans-serif;
  font-size: 14px;
  margin-bottom: 2px;
  border-bottom: 1px solid;
 color: #0099ff;
        border-color: #0099ff;
text-transform: uppercase;

}
#info-update{line-height: 20px;font-size: 13px;min-height: 260px;}
#info-update h4{font-family: MontserratBold, Arial, Helvetica, sans-serif;
  font-size: 16px;
  margin-bottom: 2px;
  border-bottom: 1px solid;
 color: #FF8200;;
        border-color: #FF8200;
text-transform: uppercase;
width: 80%;
}
</style>

{% endblock %}
{% block title %}
  Survey Map
{% endblock %}
{% block content %}
<div id="home_display">
    <div class="map-show">
        <div class="col-md-2"><br/>
            <div id="map-controls">
                {{map_filter}}
            </div><br/>
            <div id="info-update"></div><br />
            <div id="map-legend"></div>
            
            

        </div>

        <div class="col-md-6">

           <div id="survey_map" />
        </div>
    </div>
    <div class="col-md-4">
    <div id="indicators" class="indicators">
        <div class="table-responsive">
        <table id="datatables" class="table table-striped table-bordered table-hover table-sort ">
<!-- <table id="" class="table table-striped table-bordered table-hover dataTable no-footer" role="grid" aria-describedby="dynamic-table_info">
 -->
         <!-- thead>
                <tr role="row">
                    <th class="sorting" tabindex="0" aria-controls="dynamic-table" rowspan="1" colspan="1" aria-label="Price: activate to sort column ascending">Survey</th>
                    <th class="sorting" tabindex="0" aria-controls="dynamic-table" rowspan="1" colspan="1" aria-label="Domain: activate to sort column ascending">Indicator</th>
                    <th class="hidden-480 sorting" tabindex="0" aria-controls="dynamic-table" rowspan="1" colspan="1" aria-label="Clicks: activate to sort column ascending">Value</th>
                 </tr>
            </thead -->
            <tbody>
                {% for indicator in display_indicators %}
                  <tr>
                    <td>
                      <a href="{% url 'simple_indicator_chart_page' indicator.pk %}">{{ indicator.name }}</a>
                    </td>
                    <td>
                       {{ indicator.country_wide_value }}
                    </td>
                  </tr>
               {% endfor %}
             </tbody>
    </table>
  </div>
</div>
       </div> 
{% endblock%}

{% block javascripts %}
    <script type="text/javascript">
        <!--$("#survey_map").height($(document).height() * 0.7);-->
       var map = L.map('survey_map').setView([{{map_center}}], {{ zoom_level|default:6}}, {zoomControl: true, doubleClickZoom: false, scrollWheelZoom:false}),

    info = L.control(),
    //legend = L.control({position: 'bottomright'}),
    geojson;
    map.dragging.disable();
    map.touchZoom.disable();
    map.doubleClickZoom.disable();
  osmAttrib='Â© uSurvey';
  var mapData = null;

$(function(){
    $("#id_survey").on('change', function(){
        getCompletionFor();
    });
    loadInitialMap();
});



var legend = null;
var grades = [20, 40, 60, 80, 100];
var step = null;

function updateLegend2(max) {
    var oldLegend = legend;
    legend = L.control({position: 'bottomright'});
    if(max < 25)
        max = 25;       //just to make sure it is divisible into 5 places.
    step = max/5.

    legend.onAdd = function (map) {
        var div = L.DomUtil.create('div', 'info legend');
        div.innerHTML = '';
        div.innerHTML += "<strong>Interview per EA</strong><br />"
            + '<i style="background:' + getColorFor(null) + '"></i>'+ " Survey not opened<br/>";
        for (var i = 0; i < 4; i++) {
            div.innerHTML += '<i style="background:' + getColorFor(grades[i]) + '"></i> ';
            div.innerHTML += Math.floor(i*step) +" &mdash; "+ Math.floor((i + 1)*step) + "<br/>";
        }
        div.innerHTML += '<i style="background:' + getColorFor(grades[4]) + '"></i> ';
        div.innerHTML += Math.floor(4*step) +" and Above";
        return div;
    };
    try {
        if(oldLegend)
            map.removeControl(oldLegend);
    }catch(err){}
    legend.addTo(map);
}

function updateLegend(max) {
    if(max < 25)
        max = 25;       //just to make sure it is divisible into 5 places.
    step = max/5.
    var div = document.getElementById('map-legend');
    div.innerHTML = '';
    div.innerHTML += "<strong>Interview per EA</strong><br />"
        + '<i class="map-legend" style="background:' + getColorFor(null) + '"></i>'+ " Survey not opened<br/>";
    for (var i = 0; i < 4; i++) {
        div.innerHTML += '<i class="map-legend" style="background:' + getColorFor(grades[i]) + ';"></i> ';
        div.innerHTML += Math.floor(i*step) +" &mdash; "+ Math.floor((i + 1)*step) + "<br/>";
    }
    div.innerHTML += '<i class="map-legend" style="background:' + getColorFor(grades[4]) + '"></i> ';
    div.innerHTML += Math.floor(4*step) +" and Above";
}

function getCompletionFor(){
    if(!$("#id_survey").val())
        return resetMap();
    var survey_url = "{% url 'survey_json_summary' %}?survey=" + $("#id_survey").val();
    max_rate = 0;
    $.getJSON(survey_url, function (rate_data) {
        mapData.features.map(function(feature){
          var property = feature.properties['{{loc_field}}'];
          if(!property)
            property = feature.properties['{{alt_loc_field}}'];
          if(property && property.toUpperCase() in rate_data) {
            property = property.toUpperCase();
            feature.properties.rate = rate_data[property];
            max_rate = Math.max(max_rate, rate_data[property].value);
          }
          else
              feature.properties.rate = {'value': 0, description: ''};
        });
       //update legend
        updateLegend(max_rate);
       geojson = L.geoJson(mapData, {style: style, onEachFeature: onEachFeature}).addTo(map);
    });

}

function loadInitialMap(){
    $.getJSON("{{shape_file_uri}}", function (data) {
         mapData = data;
         resetMap();
      });
}


function resetMap() {
    mapData.features.map(function(feature){
            feature.properties.rate = {value: null};
        });
       geojson = L.geoJson(mapData, {style: style, onEachFeature: onEachFeature}).addTo(map);
}


function getColorFor(rate) {
    return rate > 80 && rate <= 100 ? '#800026' :
           rate > 60 && rate <= 80  ? '#BD0026' :
           rate > 40 && rate <= 60  ? '#E31A1C' :
           rate > 20 && rate <= 40  ? '#FC4E2A' :
           rate > 0  && rate <= 20  ? '#FD8D3C' :
           rate == 0 ? '#FFFFFF':
           '#8daedb';
    }

function style(feature) {
   var i = Math.floor(feature.properties.rate.value/step);
   //console.info('i: ' + i + 'grade: ' + grades[i-1] + 'rate: ' + feature.properties.rate.value + ' step: ' + step );
   try {
        return {
            fillColor: getColorFor(grades[i-1]),
            weight: 2,
            opacity: 0.55,
            color: '#fff',
            dashArray: '3',
            fillOpacity: 1
        };
    }catch(err){

    }
}

function onEachFeature(feature, layer) {
/*    var property = feature.properties['{{loc_field}}'];
 if(!property)
    property = feature.properties['{{alt_loc_field}}'];
    if(property) {
        property = property.toUpperCase();
        var label = L.marker(layer.getBounds().getCenter(), {
          icon: L.divIcon({
            className: property,
            html: '<span style="font-size: x-small;">'+property+'</span>',
            iconSize: [25, 20]
          })
            }).addTo(map);
    }*/
    layer.on({
      mouseover: highlightAdminLevel,
      click: zoomAdminLevel,
      mouseout: resetAdminLevelHighlight
  });

}

info.onAdd = function (map) {
  this._div = L.DomUtil.create('div', 'info');
  this.update();
  return this._div;
};
info.update = function (props) {
  var div = document.getElementById('info-update');
  div.innerHTML = '';
  if(typeof props != 'undefined'){
    var property = props['{{loc_field}}'];
    if(!property)
        property = props['{{alt_loc_field}}'];
    if(property) {
       property = property.toUpperCase();
        if('total_eas' in props.rate){
            rate = props.rate.value >-1 ? props.rate.value: 'Survey not opened.';
            div.innerHTML += '<h4>' + property +'</h4>';
            div.innerHTML += '<br /><strong>Interviews</strong>' +': '+ props.rate.total_interviews;
            div.innerHTML += '<br /><strong>Total EAs</strong>' +': '+ props.rate.total_eas;
            div.innerHTML += '<br /><strong>Interviews (Per EA)</strong>' +': '+ props.rate.value;
            div.innerHTML += '<br /><strong>Interviewed EAs</strong>' +': '+ props.rate.active_eas;
            div.innerHTML += '<br /><strong>Per Interviewed EA (Ave)</strong>' +': '+ props.rate.per_active_ea;
        }
        else{
            div.innerHTML = '<h4>' + property +'</h4>';
        }
    }
  }
};


<!--var survey_selector = L.control({position: 'topleft'});-->

    <!--survey_selector.onAdd = function(map){-->
        <!--var selector_div = L.DomUtil.create('div', 'survey');-->
        <!--var surveysHtml = $('#map_filter');-->
        <!--$(selector_div).html(surveysHtml.html());-->
        <!--$(surveysHtml).removeAttr('class', 'hide')-->
        <!--$(surveysHtml).remove()-->
        <!--return selector_div;-->
    <!--}-->


//survey_selector.addTo(map)

function highlightAdminLevel(event){
    var layer = event.target
    layer.setStyle({
        weight: 3,
        color:'#FF8200',
        dashArray: '',
        //fillColor: '#95bee5',
        fillOpacity: 0.3
    })
   if (!L.Browser.ie && !L.Browser.opera) {
        layer.bringToFront();
    }

    info.update(layer.feature.properties)
}

info.addTo(map);

function zoomAdminLevel(event){
    map.fitBounds(event.target.getBounds());
    var layer = event.target;
    var adminLevel = layer.feature.properties['{{loc_field}}'];
    if(!adminLevel)
         adminLevel = layer.feature.properties['{{alt_loc_field}}'];
    //alert('AdminLevel: ' + adminLevel);

}

function resetAdminLevelHighlight(event){
    geojson.resetStyle(event.target)
}

    </script>
{% endblock %}
